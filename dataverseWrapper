export async function uploadEmailAttachments(
  client: DataverseClient,
  emailId: string,
  files: FileList
): Promise<UploadResult[]> {
  const uploadSingle = (file: File): Promise<UploadResult> =>
    new Promise((resolve) => {
      const reader = new FileReader();

      reader.onload = async () => {
        try {
          const base64 = (reader.result as string).split(",")[1];

          const record = {
            "objectid_email@odata.bind": `/emails(${emailId})`,
            objecttypecode: "email",
            body: base64,
            mimetype: file.type || "application/octet-stream",
            filename: file.name,
          };

          await client.createRecord("activitymimeattachment", record);

          resolve({ file, status: "success" });
        } catch (err) {
          resolve({ file, status: "error", error: err });
        }
      };

      reader.onerror = (e) =>
        resolve({ file, status: "error", error: e });

      reader.readAsDataURL(file);
    });

  const settled = await Promise.allSettled(
    Array.from(files).map(uploadSingle)
  );

  // unwrap PromiseSettledResult â†’ UploadResult
  return settled.map((r) =>
    r.status === "fulfilled"
      ? r.value
      : {
          file: new File([], "unknown"),
          status: "error",
          error: r.reason,
        }
  );
}
