_objectid_value eq @{outputs('Get_a_row_by_ID_-_Email')?['body/activityid']}


function getErrorMessage(error: unknown): string {
  if (!error) return "Unknown error";

  if (error instanceof Error) return error.message;

  const e = error as any;
  if (e.body?.error?.message) return e.body.error.message;
  if (e.message) return e.message;
  if (e.errorMessage) return e.errorMessage;

  try {
    return JSON.stringify(error);
  } catch {
    return "An unexpected error occurred.";
  }
}






// hooks/useUploadEmailAttachments.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { DataverseClient } from "../dataverse/dataverseClient";
import { uploadEmailAttachments } from "../dataverse/attachmentsApi";

export function useUploadEmailAttachments(
  client: DataverseClient,
  emailId?: string
) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (files: FileList) => {
      if (!emailId) throw new Error("Email Id is not set.");
      await uploadEmailAttachments(client, emailId, files);
    },
    onSuccess: () => {
      if (emailId) {
        queryClient.invalidateQueries({
          queryKey: ["email-attachments", emailId],
        });
      }
    },
    retry: false,
  });
}





// hooks/useDeleteAttachment.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { DataverseClient } from "../dataverse/dataverseClient";
import { deleteAttachment } from "../dataverse/attachmentsApi";

export function useDeleteAttachment(
  client: DataverseClient,
  emailId?: string
) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (attachmentId: string) => deleteAttachment(client, attachmentId),
    onSuccess: () => {
      if (emailId) {
        queryClient.invalidateQueries({
          queryKey: ["email-attachments", emailId],
        });
      }
    },
  });
}




// hooks/useDownloadAttachment.ts
import { useMutation } from "@tanstack/react-query";
import { DataverseClient } from "../dataverse/dataverseClient";
import { downloadAttachment } from "../dataverse/attachmentsApi";

export function useDownloadAttachment(client: DataverseClient) {
  return useMutation({
    mutationFn: (attachmentId: string) => downloadAttachment(client, attachmentId),
    retry: false,
  });
}















import * as React from "react";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { DataverseClient } from "./dataverse/dataverseClient";
import { useEmailAttachments } from "./hooks/useEmailAttachments";
import { useUploadEmailAttachments } from "./hooks/useUploadEmailAttachments";
import { useDeleteAttachment } from "./hooks/useDeleteAttachment";
import { useDownloadAttachment } from "./hooks/useDownloadAttachment";
import { Header } from "./Header";

const queryClient = new QueryClient();

interface AppProps {
  dataverseClient: DataverseClient;
  emailId?: string;
}

export const App: React.FC<AppProps> = ({ dataverseClient, emailId }) => {
  const { data: attachments, isLoading } = useEmailAttachments(dataverseClient, emailId);
  const uploadMutation = useUploadEmailAttachments(dataverseClient, emailId);
  const deleteMutation = useDeleteAttachment(dataverseClient, emailId);
  const downloadMutation = useDownloadAttachment(dataverseClient);

  const fileInputRef = React.useRef<HTMLInputElement | null>(null);

  return (
    <QueryClientProvider client={queryClient}>
      <Header
        isUploading={uploadMutation.isPending}
        onClickUpload={() => fileInputRef.current?.click()}
      />

      <input
        type="file"
        multiple
        ref={fileInputRef}
        style={{ display: "none" }}
        onChange={(e) => {
          if (e.target.files) {
            uploadMutation.mutate(e.target.files);
            e.target.value = "";
          }
        }}
      />

      {/* attachments list */}
      {!isLoading && attachments && (
        <ul>
          {attachments.map((att) => (
            <li key={att.id}>
              {att.fileName}{" "}
              <button onClick={() => downloadMutation.mutate(att.id)}>Download</button>
              <button onClick={() => deleteMutation.mutate(att.id)}>Delete</button>
            </li>
          ))}
        </ul>
      )}
    </QueryClientProvider>
  );
};

