// src/dataverse/sharepointLocationApi.ts
export interface SharePointDocumentLocation {
  sharepointdocumentlocationid: string;
  name?: string;
  absoluteurl?: string | null;      // sometimes populated
  relativeurl?: string | null;      // often populated
  // lookup fields (raw OData)
  _regardingobjectid_value?: string | null;
  _parentsiteorlocation_value?: string | null;
}

export interface SharePointLocationResult {
  location: SharePointDocumentLocation;
  // A best-effort absolute URL if Dataverse doesn’t give absoluteurl
  absoluteUrl?: string | null;
  // A best-effort folder path relative to library (often "Cases/CASE-000123")
  folderPath?: string | null;
}

type DataverseClient = {
  retrieveMultiple: (
    entitySetName: string,
    query: string
  ) => Promise<{ entities: any[] }>;
};

function normalizeGuid(id: string) {
  return id.replace(/[{}]/g, "").toLowerCase();
}

/**
 * Tries to find a SharePointDocumentLocation that represents the case folder.
 *
 * Notes:
 * - For case, the regardingobject is the incident (case) record.
 * - In many setups you’ll have multiple locations; we pick the “deepest” one
 *   (usually the actual case folder, not the site root).
 */
export async function getCaseSharePointDocumentLocation(
  dataverseClient: DataverseClient,
  caseId: string
): Promise<SharePointLocationResult | null> {
  const id = normalizeGuid(caseId);

  // We’ll query locations for the case and pick the one that looks like the folder.
  // Order by createdon desc is a decent heuristic; alternatively pick the one with relativeurl populated.
  const query =
    `?$select=sharepointdocumentlocationid,name,absoluteurl,relativeurl,createdon,_parentsiteorlocation_value,_regardingobjectid_value` +
    `&$filter=_regardingobjectid_value eq ${id}` +
    `&$orderby=createdon desc`;

  const res = await dataverseClient.retrieveMultiple(
    "sharepointdocumentlocations",
    query
  );

  const rows = (res.entities ?? []) as SharePointDocumentLocation[];
  if (!rows.length) return null;

  // Heuristic: prefer a row with relativeurl (folder name) and/or absoluteurl.
  const best =
    rows.find((r) => !!r.absoluteurl) ??
    rows.find((r) => !!r.relativeurl) ??
    rows[0];

  // If absoluteurl is provided, that's simplest.
  if (best.absoluteurl) {
    return {
      location: best,
      absoluteUrl: best.absoluteurl,
      folderPath: null, // can derive later
    };
  }

  // If no absoluteurl, we still return the location row.
  // You can later resolve parent chain if needed (advanced scenario).
  return {
    location: best,
    absoluteUrl: null,
    folderPath: best.relativeurl ?? null,
  };
}





// src/hooks/useCaseSharePointLocation.ts
import { useQuery } from "@tanstack/react-query";
import { getCaseSharePointDocumentLocation } from "../dataverse/sharepointLocationApi";

type DataverseClient = {
  retrieveMultiple: (entitySetName: string, query: string) => Promise<{ entities: any[] }>;
};

export function useCaseSharePointLocation(
  dataverseClient: DataverseClient,
  linkedCase?: string | null
) {
  return useQuery({
    queryKey: ["caseSharePointLocation", linkedCase],
    enabled: !!linkedCase,
    queryFn: async () => {
      if (!linkedCase) return null;
      return await getCaseSharePointDocumentLocation(dataverseClient, linkedCase);
    },
  });
}





const { data: spLoc } = useCaseSharePointLocation(dataverseClient, linkedCase);

const handleSelectFromSharePoint = async () => {
  if (!linkedCase || !msal) return;

  if (!msal.account) await msal.signInForGraph();

  const token = await msal.acquireGraphToken();
  if (!token) return;

  if (!spLoc) {
    // toast: "No SharePoint folder found for this case"
    return;
  }

  // If you have absoluteUrl you can go straight to Graph lookup (siteId/driveId/folder listing)
  // If you only have relativeurl, you need to resolve parent chain (next section)
  console.log("Case SP location:", spLoc);
};
