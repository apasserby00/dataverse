await Promise.allSettled(
  Array.from(files).map(uploadSingle)
);



const uploadSingle = (file: File) =>
  new Promise<{ file: File; status: "success" | "error"; error?: unknown }>(
    (resolve) => {
      const reader = new FileReader();

      reader.onload = async () => {
        try {
          const base64 = (reader.result as string).split(",")[1];

          const record = {
            "objectid_email@odata.bind": `/emails(${emailId})`,
            objecttypecode: "email",
            body: base64,
            mimetype: file.type || "application/octet-stream",
            filename: file.name,
          };

          await client.createRecord("activitymimeattachment", record);

          resolve({ file, status: "success" });
        } catch (err) {
          resolve({ file, status: "error", error: err });
        }
      };

      reader.onerror = (e) =>
        resolve({ file, status: "error", error: e });

      reader.readAsDataURL(file);
    }
  );



const results = await Promise.allSettled(
  Array.from(files).map(uploadSingle)
);

return results;






onSuccess: (results) => {
  const successes = results.filter(
    (r) => r.status === "fulfilled" && r.value.status === "success"
  );

  const failures = results.filter(
    (r) => r.status === "fulfilled" && r.value.status === "error"
  );

  if (successes.length) {
    toast.success(`${successes.length} attachments uploaded`);
  }

  if (failures.length) {
    toast.warning(`${failures.length} attachments failed`);
  }

  queryClient.invalidateQueries({
    queryKey: ["email-attachments", emailId],
  });
};
