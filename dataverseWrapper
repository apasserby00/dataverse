export function parseSharePointSiteFromFolderUrl(absoluteFolderUrl: string) {
  const u = new URL(absoluteFolderUrl);

  // pathname example:
  // /sites/DEV-CMS-CORE-2025-100-134/Shared Documents/General/Case Files
  const parts = u.pathname.split("/").filter(Boolean).map(decodeURIComponent);

  if (parts.length < 2) throw new Error(`Unexpected SharePoint URL: ${absoluteFolderUrl}`);

  const sitePath = `${parts[0]}/${parts[1]}`; // "sites/SITE"
  return { hostname: u.hostname, sitePath };
}


export function getPathRelativeToDriveRoot(driveWebUrl: string, folderAbsoluteUrl: string) {
  const drive = new URL(driveWebUrl);
  const folder = new URL(folderAbsoluteUrl);

  const drivePath = decodeURIComponent(drive.pathname).replace(/\/+$/g, "");
  const folderPath = decodeURIComponent(folder.pathname);

  // folder must live under the drive root path
  if (!folderPath.toLowerCase().startsWith(drivePath.toLowerCase() + "/")) {
    throw new Error(
      `Folder URL is not under drive root.\nDrive root: ${drivePath}\nFolder: ${folderPath}`
    );
  }

  // remove "/Shared Documents/" (or whatever the drive root is)
  return folderPath.slice(drivePath.length + 1); // e.g. "General/Case Files"
}

export function encodeGraphPath(path: string) {
  return path
    .split("/")
    .filter(Boolean)
    .map(encodeURIComponent)
    .join("/");
}







import {
  getSharePointSiteId,
  getDefaultDriveId,
  getDrive, // add this (see next section)
  getFolderItemIdByPath,
  listFolderChildren,
  type GraphDriveItem,
} from "./graphApi";

import {
  parseSharePointSiteFromFolderUrl,
  getPathRelativeToDriveRoot,
  encodeGraphPath,
} from "../utils";

export async function getCaseFilesFromSharePoint(params: {
  token: string;
  absoluteFolderUrl: string;
}): Promise<GraphDriveItem[]> {
  const { token, absoluteFolderUrl } = params;

  // 1) Parse hostname + sitePath
  const siteParsed = parseSharePointSiteFromFolderUrl(absoluteFolderUrl);

  // 2) Get siteId
  const siteId = await getSharePointSiteId(token, siteParsed.hostname, siteParsed.sitePath);

  // 3) Get the actual drive object (so we have drive.webUrl)
  const drive = await getDrive(token, siteId); // returns { id, webUrl, ... }

  // 4) Convert folder URL to a drive-relative path (e.g. "General/Case Files")
  const relativePath = getPathRelativeToDriveRoot(drive.webUrl, absoluteFolderUrl);
  const encodedPath = encodeGraphPath(relativePath);

  // 5) Resolve folder item and list children
  const folderItemId = await getFolderItemIdByPath(token, drive.id, encodedPath);
  return await listFolderChildren(token, drive.id, folderItemId);
}





export async function getDrive(token: string, siteId: string): Promise<{ id: string; webUrl: string }> {
  const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/drive?$select=id,webUrl`;
  const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
  if (!res.ok) throw new Error(`Failed to get drive: ${res.status}`);
  return await res.json();
}







export async function getFolderItemIdByPath(
  token: string,
  driveId: string,
  encodedPath: string
): Promise<string> {
  const url = `https://graph.microsoft.com/v1.0/drives/${driveId}/root:/${encodedPath}`;
  const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
  if (!res.ok) throw new Error(`Failed to get folder item: ${res.status}`);
  const data = await res.json();
  return data.id;
}









