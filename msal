// AppRoot.tsx
import * as React from "react";
import { PublicClientApplication } from "@azure/msal-browser";
import { MsalProvider } from "@azure/msal-react";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { useEnvironmentVariables } from "./hooks/useEnvironmentVariables";
import { AppInner } from "./AppInner";

const queryClient = new QueryClient();

interface AppRootProps {
  dataverseClient: DataverseClient;
  emailId?: string;
}

export const AppRoot: React.FC<AppRootProps> = ({ dataverseClient, emailId }) => {
  const { data: env, isLoading, isError } = useEnvironmentVariables(dataverseClient, [
    "new_TenantId",
    "new_ClientId",
    "new_GraphScope", // optional
  ]);

  if (isLoading) return <div>Loading authentication...</div>;
  if (isError) return <div>Failed to load configuration.</div>;

  const tenantId = env?.["new_TenantId"];
  const clientId = env?.["new_ClientId"];
  const scope = env?.["new_GraphScope"] ?? "Files.Read.All";

  if (!tenantId || !clientId) {
    return <div>Missing authentication environment variables.</div>;
  }

  const msalInstance = new PublicClientApplication({
    auth: {
      clientId,
      authority: `https://login.microsoftonline.com/${tenantId}`,
      redirectUri: window.location.origin, // works for popup
    },
    cache: {
      cacheLocation: "sessionStorage",
    },
  });

  return (
    <MsalProvider instance={msalInstance}>
      <QueryClientProvider client={queryClient}>
        <AppInner
          dataverseClient={dataverseClient}
          emailId={emailId}
          graphScope={scope}
        />
      </QueryClientProvider>
    </MsalProvider>
  );
};









import { Configuration, LogLevel } from "@azure/msal-browser";

export const msalConfig: Configuration = {
  auth: {
    clientId: "<YOUR-SPA-APP-CLIENT-ID>",
    authority: "https://login.microsoftonline.com/<YOUR-TENANT-ID>",
    redirectUri: window.location.origin, // usually fine for popup in PCF
  },
  cache: {
    cacheLocation: "sessionStorage", // or "localStorage" if you prefer
    storeAuthStateInCookie: false,
  },
  system: {
    loggerOptions: {
      logLevel: LogLevel.Error,
      loggerCallback: () => {},
    },
  },
};

// Graph scopes youâ€™ll use
export const graphLoginRequest = {
  scopes: ["Files.Read.All"], // delegated Graph permission (needs admin consent)
};






2
import { PublicClientApplication } from "@azure/msal-browser";
import { MsalProvider } from "@azure/msal-react";
import { msalConfig } from "./auth/msalConfig";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { createDataverseClient } from "./dataverse/dataverseClient";
import { App } from "./App";

const msalInstance = new PublicClientApplication(msalConfig);
const queryClient = new QueryClient();

export class AttachmentManagerControl implements ComponentFramework.StandardControl<IInputs, IOutputs> {
  // ...init boilerplate omitted

  public init(context, notifyOutputChanged, state, container): void {
    const dataverseClient = createDataverseClient(context.webAPI);
    const emailId = context.parameters.emailId.raw ?? undefined;

    const element = (
      <MsalProvider instance={msalInstance}>
        <QueryClientProvider client={queryClient}>
          <App dataverseClient={dataverseClient} emailId={emailId} />
        </QueryClientProvider>
      </MsalProvider>
    );

    ReactDOM.render(element, container);
  }

  // ...
}






3 auth/useMsalAuth.ts


import { useMsal, useAccount } from "@azure/msal-react";
import { graphLoginRequest } from "./msalConfig";

export function useMsalAuth() {
  const { instance, accounts } = useMsal();
  const account = useAccount(accounts[0] ?? null);

  const login = async () => {
    if (account) return account;

    const res = await instance.loginPopup(graphLoginRequest);
    return res.account;
  };

  const acquireGraphToken = async () => {
    const activeAccount =
      account || instance.getActiveAccount() || (await login());

    try {
      const res = await instance.acquireTokenSilent({
        account: activeAccount!,
        scopes: graphLoginRequest.scopes,
      });
      return res.accessToken;
    } catch {
      // fallback to popup if silent fails (new consent, etc.)
      const res = await instance.acquireTokenPopup(graphLoginRequest);
      return res.accessToken;
    }
  };

  const logout = () => {
    instance.logoutPopup({
      account: account ?? instance.getActiveAccount() ?? undefined,
    });
  };

  return {
    account,
    login,
    logout,
    acquireGraphToken,
  };
}











// hooks/useSharePointFiles.ts
import { useQuery } from "@tanstack/react-query";
import { useMsalAuth } from "../auth/useMsalAuth";

export interface GraphDriveItem {
  id: string;
  name: string;
  webUrl: string;
  size: number;
  file?: { mimeType?: string };
  folder?: { childCount?: number };
}

interface UseSharePointFilesOptions {
  siteId: string;           // SharePoint site ID (e.g. from admin)
  folderPath?: string;      // e.g. "Shared Documents/MyFolder"
}

export function useSharePointFiles({ siteId, folderPath }: UseSharePointFilesOptions) {
  const { acquireGraphToken } = useMsalAuth();

  return useQuery<GraphDriveItem[]>({
    queryKey: ["sharepoint-files", siteId, folderPath],
    enabled: !!siteId,
    queryFn: async () => {
      const token = await acquireGraphToken();

      const baseUrl = "https://graph.microsoft.com/v1.0";
      const path = folderPath
        ? `/sites/${siteId}/drive/root:/${encodeURI(folderPath)}:/children`
        : `/sites/${siteId}/drive/root/children`;

      const res = await fetch(`${baseUrl}${path}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Graph error ${res.status}: ${text}`);
      }

      const json = await res.json();
      return json.value as GraphDriveItem[];
    },
  });
}

