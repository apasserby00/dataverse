// hooks/useSharePointSiteId.ts
import { useQuery } from "@tanstack/react-query";
import { useMsalAuth } from "../auth/useMsalAuth";

export function useSharePointSiteId(hostname: string, sitePath: string, scope: string) {
  const { acquireGraphToken } = useMsalAuth(scope);

  return useQuery({
    queryKey: ["sharepoint-site-id", hostname, sitePath],
    enabled: !!hostname && !!sitePath,
    queryFn: async () => {
      const token = await acquireGraphToken();
      if (!token) throw new Error("Not authenticated to Graph");

      const url = `https://graph.microsoft.com/v1.0/sites/${hostname}:/${sitePath}?$select=id`;

      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Failed to get site ID (${res.status}): ${text}`);
      }

      const json = await res.json();
      return json.id as string;
    },
    staleTime: Infinity,
  });
}
