// useMsalAuth.ts
import { useMsal, useAccount } from "@azure/msal-react";

export function useMsalAuth(scope: string) {
  const { instance, accounts } = useMsal();
  const account = useAccount(accounts[0] ?? null);

  // Explicit login only when user clicks
  const signInForGraph = async () => {
    const res = await instance.loginPopup({ scopes: [scope] });
    return res.account;
  };

  const acquireGraphToken = async () => {
    const active = account || instance.getActiveAccount();

    if (!active) {
      // User not signed in â†’ return null instead of forcing login
      return null;
    }

    try {
      const res = await instance.acquireTokenSilent({
        account: active,
        scopes: [scope],
      });
      return res.accessToken;
    } catch {
      return null;
    }
  };

  const logout = () => {
    instance.logoutPopup();
  };

  return {
    account,
    signInForGraph,
    acquireGraphToken,
    logout,
  };
}











3 auth/useMsalAuth.ts


import { useMsal, useAccount } from "@azure/msal-react";
import { graphLoginRequest } from "./msalConfig";

export function useMsalAuth() {
  const { instance, accounts } = useMsal();
  const account = useAccount(accounts[0] ?? null);

  const login = async () => {
    if (account) return account;

    const res = await instance.loginPopup(graphLoginRequest);
    return res.account;
  };

  const acquireGraphToken = async () => {
    const activeAccount =
      account || instance.getActiveAccount() || (await login());

    try {
      const res = await instance.acquireTokenSilent({
        account: activeAccount!,
        scopes: graphLoginRequest.scopes,
      });
      return res.accessToken;
    } catch {
      // fallback to popup if silent fails (new consent, etc.)
      const res = await instance.acquireTokenPopup(graphLoginRequest);
      return res.accessToken;
    }
  };

  const logout = () => {
    instance.logoutPopup({
      account: account ?? instance.getActiveAccount() ?? undefined,
    });
  };

  return {
    account,
    login,
    logout,
    acquireGraphToken,
  };
}











// hooks/useSharePointFiles.ts
import { useQuery } from "@tanstack/react-query";
import { useMsalAuth } from "../auth/useMsalAuth";

export interface GraphDriveItem {
  id: string;
  name: string;
  webUrl: string;
  size: number;
  file?: { mimeType?: string };
  folder?: { childCount?: number };
}

interface UseSharePointFilesOptions {
  siteId: string;           // SharePoint site ID (e.g. from admin)
  folderPath?: string;      // e.g. "Shared Documents/MyFolder"
}

export function useSharePointFiles({ siteId, folderPath }: UseSharePointFilesOptions) {
  const { acquireGraphToken } = useMsalAuth();

  return useQuery<GraphDriveItem[]>({
    queryKey: ["sharepoint-files", siteId, folderPath],
    enabled: !!siteId,
    queryFn: async () => {
      const token = await acquireGraphToken();

      const baseUrl = "https://graph.microsoft.com/v1.0";
      const path = folderPath
        ? `/sites/${siteId}/drive/root:/${encodeURI(folderPath)}:/children`
        : `/sites/${siteId}/drive/root/children`;

      const res = await fetch(`${baseUrl}${path}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Graph error ${res.status}: ${text}`);
      }

      const json = await res.json();
      return json.value as GraphDriveItem[];
    },
  });
}

