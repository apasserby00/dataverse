// AppRoot.tsx
export const AppRoot = ({ dataverseClient, emailId, linkedCase }) => {
  // load env vars only if linked case is present
  const shouldUseGraph = !!linkedCase;

  const envQuery = useEnvironmentVariables(
    dataverseClient,
    ["new_TenantId", "new_ClientId", "new_GraphScope"],
    { enabled: shouldUseGraph }  // <- IMPORTANT
  );

  const { data: env, isLoading, isError } = envQuery;

  let msalInstance = null;
  let graphScope = "Files.Read.All";

  if (shouldUseGraph) {
    if (isLoading) {
      return <div>Loading SharePoint configurationâ€¦</div>;
    }

    if (isError) {
      console.error("Failed to load env vars");
    }

    const tenantId = env?.new_TenantId;
    const clientId = env?.new_ClientId;
    graphScope = env?.new_GraphScope ?? "Files.Read.All";

    if (tenantId && clientId) {
      msalInstance = new PublicClientApplication({
        auth: {
          clientId,
          authority: `https://login.microsoftonline.com/${tenantId}`,
          redirectUri: window.location.origin,
        },
        cache: {
          cacheLocation: "sessionStorage",
        },
      });
    }
  }

  return msalInstance ? (
    <MsalProvider instance={msalInstance}>
      <QueryClientProvider client={queryClient}>
        <AppInner
          dataverseClient={dataverseClient}
          emailId={emailId}
          graphScope={graphScope}
          linkedCase={linkedCase}
        />
      </QueryClientProvider>
    </MsalProvider>
  ) : (
    <QueryClientProvider client={queryClient}>
      <AppInner
        dataverseClient={dataverseClient}
        emailId={emailId}
        graphScope={graphScope}   // default is fine
        linkedCase={linkedCase}
        graphDisabled={true}       // <- disables SP button
      />
    </QueryClientProvider>
  );
};





const AppInner = ({
  dataverseClient,
  emailId,
  graphScope,
  linkedCase,
  graphDisabled,
}) => {
  // Only setup MSAL hooks if Graph is enabled
  const msal = !graphDisabled
    ? useMsalAuth(graphScope)
    : null;

  const isGraphSignedIn = !!msal?.account;

  const handleSelectFromSharePoint = async () => {
    if (graphDisabled) return; // do nothing

    // If not signed in, prompt
    if (!msal.account) {
      await msal.signInForGraph(); 
    }

    const token = await msal.acquireGraphToken();
    if (!token) return;

    openSharePointPicker(token, linkedCase);
  };

  return (
    <Header
      onClickSelectFromSharePoint={handleSelectFromSharePoint}
      sharePointEnabled={!graphDisabled}
      isGraphSignedIn={isGraphSignedIn}
      linkedCase={linkedCase}
      {...otherHeaderProps}
    />
  );
};










3 auth/useMsalAuth.ts


import { useMsal, useAccount } from "@azure/msal-react";
import { graphLoginRequest } from "./msalConfig";

export function useMsalAuth() {
  const { instance, accounts } = useMsal();
  const account = useAccount(accounts[0] ?? null);

  const login = async () => {
    if (account) return account;

    const res = await instance.loginPopup(graphLoginRequest);
    return res.account;
  };

  const acquireGraphToken = async () => {
    const activeAccount =
      account || instance.getActiveAccount() || (await login());

    try {
      const res = await instance.acquireTokenSilent({
        account: activeAccount!,
        scopes: graphLoginRequest.scopes,
      });
      return res.accessToken;
    } catch {
      // fallback to popup if silent fails (new consent, etc.)
      const res = await instance.acquireTokenPopup(graphLoginRequest);
      return res.accessToken;
    }
  };

  const logout = () => {
    instance.logoutPopup({
      account: account ?? instance.getActiveAccount() ?? undefined,
    });
  };

  return {
    account,
    login,
    logout,
    acquireGraphToken,
  };
}











// hooks/useSharePointFiles.ts
import { useQuery } from "@tanstack/react-query";
import { useMsalAuth } from "../auth/useMsalAuth";

export interface GraphDriveItem {
  id: string;
  name: string;
  webUrl: string;
  size: number;
  file?: { mimeType?: string };
  folder?: { childCount?: number };
}

interface UseSharePointFilesOptions {
  siteId: string;           // SharePoint site ID (e.g. from admin)
  folderPath?: string;      // e.g. "Shared Documents/MyFolder"
}

export function useSharePointFiles({ siteId, folderPath }: UseSharePointFilesOptions) {
  const { acquireGraphToken } = useMsalAuth();

  return useQuery<GraphDriveItem[]>({
    queryKey: ["sharepoint-files", siteId, folderPath],
    enabled: !!siteId,
    queryFn: async () => {
      const token = await acquireGraphToken();

      const baseUrl = "https://graph.microsoft.com/v1.0";
      const path = folderPath
        ? `/sites/${siteId}/drive/root:/${encodeURI(folderPath)}:/children`
        : `/sites/${siteId}/drive/root/children`;

      const res = await fetch(`${baseUrl}${path}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Graph error ${res.status}: ${text}`);
      }

      const json = await res.json();
      return json.value as GraphDriveItem[];
    },
  });
}

