// Case → lookup
private const string CaseLookupField = "CASE_LOOKUP_FIELD";

// Lookup target → code field
private const string LookupCodeField = "CODE_FIELD";

// Routing rule
private const string MatchCodeValue = "MATCH_VALUE";

// Queue names
private const string PrimaryQueueName = "PRIMARY_QUEUE";
private const string SecondaryQueueName = "SECONDARY_QUEUE";


private static Guid ResolveQueueForCase(
    IOrganizationService service,
    EntityReference caseRef,
    ITracingService tracing)
{
    // 1) Retrieve case and get lookup
    var caseEntity = service.Retrieve(
        caseRef.LogicalName,
        caseRef.Id,
        new ColumnSet(CaseLookupField));

    var lookupRef = caseEntity.GetAttributeValue<EntityReference>(CaseLookupField);

    if (lookupRef == null)
    {
        tracing.Trace("ResolveQueueForCase: Case lookup is null. Using secondary queue.");
        return GetQueueIdByName(service, SecondaryQueueName, tracing);
    }

    // 2) Retrieve lookup target and get code
    var lookupEntity = service.Retrieve(
        lookupRef.LogicalName,
        lookupRef.Id,
        new ColumnSet(LookupCodeField));

    var code = lookupEntity.GetAttributeValue<string>(LookupCodeField);

    tracing.Trace("ResolveQueueForCase: Code value = {0}", code ?? "(null)");

    // 3) Routing decision
    if (string.Equals(code, MatchCodeValue, StringComparison.OrdinalIgnoreCase))
        return GetQueueIdByName(service, PrimaryQueueName, tracing);

    return GetQueueIdByName(service, SecondaryQueueName, tracing);
}


private static Guid GetQueueIdByName(
    IOrganizationService service,
    string queueName,
    ITracingService tracing)
{
    var qe = new QueryExpression("queue")
    {
        ColumnSet = new ColumnSet("queueid"),
        TopCount = 1
    };

    qe.Criteria.AddCondition("name", ConditionOperator.Equal, queueName);

    var result = service.RetrieveMultiple(qe);
    var queue = result.Entities.FirstOrDefault();

    if (queue == null)
    {
        tracing.Trace("GetQueueIdByName: Queue not found: {0}", queueName);
        return Guid.Empty;
    }

    return queue.Id;
}
